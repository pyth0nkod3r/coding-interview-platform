openapi: 3.0.3
info:
  title: Coding Interview Platform API
  description: |
    Backend API for the Coding Interview Platform. This API supports:
    - User authentication (login, signup, logout)
    - Interview session management
    - Real-time code collaboration
    - Question management
    - Chat/messaging
    - Private notes
    - Permission controls
  version: 1.0.0
  contact:
    name: API Support

servers:
  - url: http://localhost:3000/api/v1
    description: Local development server
  - url: https://api.interview-platform.com/v1
    description: Production server

tags:
  - name: Authentication
    description: User authentication and management
  - name: Sessions
    description: Interview session management
  - name: Questions
    description: Interview question management within sessions
  - name: Messages
    description: Chat/messaging within sessions
  - name: Notes
    description: Private notes within sessions
  - name: Code
    description: Code execution and state management

paths:
  # ============================================
  # Authentication Endpoints
  # ============================================
  /auth/login:
    post:
      tags:
        - Authentication
      summary: Login user
      description: Authenticate a user with username and return user data with auth token
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
              properties:
                username:
                  type: string
                  example: "john_doe"
      responses:
        '200':
          description: Successful login
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/signup:
    post:
      tags:
        - Authentication
      summary: Register new user
      description: Create a new user account with specified role
      operationId: signup
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - email
                - role
              properties:
                username:
                  type: string
                  example: "john_doe"
                email:
                  type: string
                  format: email
                  example: "john@example.com"
                role:
                  $ref: '#/components/schemas/UserRole'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Username already taken
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: Logout user
      description: Invalidate user session
      operationId: logout
      security:
        - bearerAuth: []
      responses:
        '204':
          description: Successfully logged out
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/me:
    get:
      tags:
        - Authentication
      summary: Get current user
      description: Get the currently authenticated user's information
      operationId: getCurrentUser
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ============================================
  # Session Endpoints
  # ============================================
  /sessions:
    post:
      tags:
        - Sessions
      summary: Create interview session
      description: Create a new interview session. Only users with 'interviewer' role can create sessions.
      operationId: createSession
      security:
        - bearerAuth: []
      responses:
        '201':
          description: Session created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InterviewSession'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Only interviewers can create sessions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    get:
      tags:
        - Sessions
      summary: Get all sessions
      description: Get all interview sessions for the authenticated user
      operationId: getAllSessions
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          description: Filter by session status
          schema:
            $ref: '#/components/schemas/SessionStatus'
      responses:
        '200':
          description: List of sessions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/InterviewSession'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /sessions/{sessionId}:
    get:
      tags:
        - Sessions
      summary: Get session by ID
      description: Get a single interview session by its ID
      operationId: getSession
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: Session data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InterviewSession'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags:
        - Sessions
      summary: Update session
      description: Update session properties (code state, permissions, etc.)
      operationId: updateSession
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SessionUpdate'
      responses:
        '200':
          description: Session updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InterviewSession'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /sessions/{sessionId}/join:
    post:
      tags:
        - Sessions
      summary: Join session as candidate
      description: Join an existing interview session as a candidate
      operationId: joinSession
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: Successfully joined session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InterviewSession'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Session already has a candidate or is ended
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /sessions/{sessionId}/end:
    post:
      tags:
        - Sessions
      summary: End session
      description: End an interview session. Only the interviewer can end a session.
      operationId: endSession
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: Session ended
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InterviewSession'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Only interviewer can end session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'

  # ============================================
  # Permission Endpoints
  # ============================================
  /sessions/{sessionId}/permissions/typing:
    post:
      tags:
        - Sessions
      summary: Toggle candidate typing permission
      description: Toggle whether the candidate can type in the code editor
      operationId: toggleCandidateTyping
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: Permission toggled
          content:
            application/json:
              schema:
                type: object
                properties:
                  canCandidateType:
                    type: boolean
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Only interviewer can change permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /sessions/{sessionId}/permissions/run:
    post:
      tags:
        - Sessions
      summary: Toggle candidate run permission
      description: Toggle whether the candidate can run code
      operationId: toggleCandidateRun
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: Permission toggled
          content:
            application/json:
              schema:
                type: object
                properties:
                  canCandidateRun:
                    type: boolean
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Only interviewer can change permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ============================================
  # Question Endpoints
  # ============================================
  /sessions/{sessionId}/questions:
    get:
      tags:
        - Questions
      summary: Get all questions
      description: Get all questions for a session
      operationId: getQuestions
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: List of questions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Question'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    post:
      tags:
        - Questions
      summary: Add question
      description: Add a new question to the session. Only interviewer can add questions.
      operationId: addQuestion
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
                - content
              properties:
                title:
                  type: string
                  example: "Two Sum Problem"
                content:
                  type: string
                  example: "Given an array of integers nums and an integer target..."
      responses:
        '201':
          description: Question added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Question'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Only interviewer can add questions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'

  /sessions/{sessionId}/questions/{questionId}:
    put:
      tags:
        - Questions
      summary: Update question
      description: Update an existing question
      operationId: updateQuestion
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
        - $ref: '#/components/parameters/QuestionId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
                - content
              properties:
                title:
                  type: string
                content:
                  type: string
      responses:
        '200':
          description: Question updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Question'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Only interviewer can update questions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - Questions
      summary: Remove question
      description: Remove a question from the session
      operationId: removeQuestion
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
        - $ref: '#/components/parameters/QuestionId'
      responses:
        '204':
          description: Question removed
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Only interviewer can remove questions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'

  # ============================================
  # Message Endpoints
  # ============================================
  /sessions/{sessionId}/messages:
    get:
      tags:
        - Messages
      summary: Get all messages
      description: Get all chat messages for a session
      operationId: getMessages
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
        - name: since
          in: query
          description: Get messages since this timestamp (for polling)
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: List of messages
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Message'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    post:
      tags:
        - Messages
      summary: Send message
      description: Send a chat message to the session
      operationId: addMessage
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - content
              properties:
                content:
                  type: string
                  example: "Let me explain the approach..."
      responses:
        '201':
          description: Message sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Message'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  # ============================================
  # Notes Endpoints
  # ============================================
  /sessions/{sessionId}/notes:
    get:
      tags:
        - Notes
      summary: Get private notes
      description: Get the current user's private notes for a session
      operationId: getUserNotes
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: User's private notes
          content:
            application/json:
              schema:
                type: object
                properties:
                  notes:
                    type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - Notes
      summary: Update private notes
      description: Update the current user's private notes for a session
      operationId: updateUserNotes
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/SessionId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - notes
              properties:
                notes:
                  type: string
      responses:
        '200':
          description: Notes updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  notes:
                    type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  # ============================================
  # Code Execution Endpoint
  # ============================================
  /code/execute:
    post:
      tags:
        - Code
      summary: Execute code
      description: Execute code and return the output. This is stateless and doesn't require a session.
      operationId: executeCode
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - code
                - language
              properties:
                code:
                  type: string
                  example: "console.log('Hello, World!');"
                language:
                  $ref: '#/components/schemas/Language'
      responses:
        '200':
          description: Code execution result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecutionResult'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '400':
          description: Invalid code or language
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

# ============================================
# Components
# ============================================
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT authentication token

  parameters:
    SessionId:
      name: sessionId
      in: path
      required: true
      description: Unique identifier for the interview session
      schema:
        type: string
        example: "abc123xyz"

    QuestionId:
      name: questionId
      in: path
      required: true
      description: Unique identifier for the question
      schema:
        type: string
        example: "q1a2b3c"

  responses:
    Unauthorized:
      description: Authentication required or token invalid
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  schemas:
    UserRole:
      type: string
      enum:
        - interviewer
        - candidate
      example: "interviewer"

    SessionStatus:
      type: string
      enum:
        - active
        - ended
      example: "active"

    Language:
      type: string
      enum:
        - javascript
        - python
        - typescript
      example: "javascript"

    User:
      type: object
      required:
        - id
        - username
        - email
        - role
      properties:
        id:
          type: string
          example: "usr_abc123"
        username:
          type: string
          example: "john_doe"
        email:
          type: string
          format: email
          example: "john@example.com"
        role:
          $ref: '#/components/schemas/UserRole'

    AuthResponse:
      type: object
      required:
        - user
        - token
      properties:
        user:
          $ref: '#/components/schemas/User'
        token:
          type: string
          description: JWT authentication token
          example: "eyJhbGciOiJIUzI1NiIs..."

    Question:
      type: object
      required:
        - id
        - title
        - content
        - createdAt
      properties:
        id:
          type: string
          example: "q_xyz789"
        title:
          type: string
          example: "Two Sum Problem"
        content:
          type: string
          example: "Given an array of integers nums and an integer target, return indices of the two numbers such that they add up to target."
        createdAt:
          type: integer
          format: int64
          description: Timestamp in milliseconds
          example: 1702234567890

    Message:
      type: object
      required:
        - id
        - senderId
        - senderRole
        - senderName
        - content
        - timestamp
      properties:
        id:
          type: string
          example: "msg_def456"
        senderId:
          type: string
          example: "usr_abc123"
        senderRole:
          $ref: '#/components/schemas/UserRole'
        senderName:
          type: string
          example: "John Doe"
        content:
          type: string
          example: "Can you explain your approach?"
        timestamp:
          type: integer
          format: int64
          description: Timestamp in milliseconds
          example: 1702234567890

    CodeState:
      type: object
      required:
        - code
        - language
      properties:
        code:
          type: string
          example: "function twoSum(nums, target) {\n  // Your code here\n}"
        language:
          $ref: '#/components/schemas/Language'
        output:
          type: array
          items:
            type: string
          example: ["[0, 1]"]
        isRunning:
          type: boolean
          example: false

    Permissions:
      type: object
      required:
        - canCandidateRun
        - canCandidateType
      properties:
        canCandidateRun:
          type: boolean
          description: Whether the candidate can run code
          example: true
        canCandidateType:
          type: boolean
          description: Whether the candidate can type in the editor
          example: true

    InterviewSession:
      type: object
      required:
        - id
        - interviewerId
        - createdAt
        - status
        - questions
        - codeState
        - permissions
        - sharedMessages
      properties:
        id:
          type: string
          example: "sess_abc123xyz"
        interviewerId:
          type: string
          example: "usr_interviewer1"
        candidateId:
          type: string
          nullable: true
          example: "usr_candidate1"
        createdAt:
          type: integer
          format: int64
          description: Timestamp in milliseconds
          example: 1702234567890
        status:
          $ref: '#/components/schemas/SessionStatus'
        questions:
          type: array
          items:
            $ref: '#/components/schemas/Question'
        codeState:
          $ref: '#/components/schemas/CodeState'
        permissions:
          $ref: '#/components/schemas/Permissions'
        privateNotes:
          type: object
          additionalProperties:
            type: string
          description: Private notes keyed by user ID (only current user's notes returned)
          example:
            usr_abc123: "Good problem-solving approach"
        sharedMessages:
          type: array
          items:
            $ref: '#/components/schemas/Message'

    SessionUpdate:
      type: object
      properties:
        codeState:
          $ref: '#/components/schemas/CodeState'
        permissions:
          $ref: '#/components/schemas/Permissions'

    ExecutionResult:
      type: object
      required:
        - output
      properties:
        output:
          type: array
          items:
            type: string
          example: ["Hello, World!"]
        error:
          type: string
          nullable: true
          example: null

    Error:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          example: "Resource not found"
        code:
          type: string
          example: "NOT_FOUND"
